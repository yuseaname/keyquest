# KeyQuest - Cloud Save Architecture

## Data Flow Diagram

```
???????????????????????????????????????????????????????????????????
?                         USER OPENS GAME                         ?
???????????????????????????????????????????????????????????????????
                         ?
                         ?
            ??????????????????????????
            ?  useFirebaseAuth Hook  ?
            ?  Runs on App Mount     ?
            ??????????????????????????
                     ?
        ???????????????????????????
        ?                         ?
        ?                         ?
????????????????          ????????????????
? User Exists? ?   NO     ? Sign In      ?
? Check Auth   ???????????? Anonymously  ?
????????????????          ????????????????
       ? YES                     ?
       ?                         ?
       ???????????????????????????
                  ?
                  ?
         ??????????????????
         ? Load User Doc  ?
         ? from Firestore ?
         ??????????????????
                  ?
         ???????????????????
         ?                 ?
         ?                 ?
    ??????????        ???????????
    ? Exists ?   NO   ? Create  ?
    ?   ?    ?????????? New Doc ?
    ??????????        ???????????
         ? YES             ?
         ???????????????????
                  ?
                  ?
         ??????????????????
         ? Update Zustand ?
         ? Game Store     ?
         ??????????????????
                  ?
                  ?
         ??????????????????
         ?  Game Ready!   ?
         ??????????????????
```

## Auto-Save Flow

```
???????????????????????????????????????????????????????????????????
?                    PLAYER MAKES CHANGES                         ?
?  (Creates character, levels up, changes settings, etc.)         ?
???????????????????????????????????????????????????????????????????
                         ?
                         ?
            ??????????????????????????
            ?   Zustand Store        ?
            ?   State Updates        ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  useAutoSave Hook      ?
            ?  Detects Changes       ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  2-Second Debounce     ?
            ?  (Prevents Spam)       ?
            ??????????????????????????
                     ?
        ???????????????????????????
        ?                         ?
        ?                         ?
????????????????          ????????????????
?  Online?     ?   NO     ?  Store in    ?
?              ????????????  IndexedDB   ?
????????????????          ????????????????
       ? YES                     
       ?                         
       ?                         
????????????????          
? Save to      ?          
? Firestore    ?          
????????????????          
       ?                  
       ?                  
????????????????          
? Show Cloud   ?          
? Save Icon    ?          
????????????????          
```

## Battle End Flow

```
???????????????????????????????????????????????????????????????????
?                       BATTLE ENDS                               ?
?              (Victory or Defeat)                                ?
???????????????????????????????????????????????????????????????????
                         ?
                         ?
            ??????????????????????????
            ?  useBattleSave Hook    ?
            ?  Detects Status Change ?
            ??????????????????????????
                     ?
        ???????????????????????????
        ?                         ?
        ?                         ?
????????????????          ????????????????
? Calculate    ?          ? Update User  ?
? Battle Stats ?          ? Statistics   ?
? (WPM, Acc)   ?          ? (Battles Won)?
????????????????          ????????????????
       ?                         ?
       ???????????????????????????
                  ?
                  ?
         ??????????????????
         ? Save Battle Log?
         ? to Firestore   ?
         ? /users/{uid}/  ?
         ? battles/       ?
         ??????????????????
                  ?
                  ?
         ??????????????????
         ? Update         ?
         ? Character XP   ?
         ? and Stats      ?
         ??????????????????
```

## Offline Support

```
???????????????????????????????????????????????????????????????????
?                    PLAYER GOES OFFLINE                          ?
???????????????????????????????????????????????????????????????????
                         ?
                         ?
            ??????????????????????????
            ?  Browser Detects       ?
            ?  'offline' Event       ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Show "Offline" Icon   ?
            ?  in SaveIndicator      ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Player Continues      ?
            ?  Playing Normally      ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Changes Stored in     ?
            ?  IndexedDB (Automatic) ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Player Goes Online    ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Firebase Auto-Syncs   ?
            ?  All Pending Changes   ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Show "Saved" Icon     ?
            ??????????????????????????
```

## Security Architecture

```
???????????????????????????????????????????????????????????????????
?                    FIRESTORE SECURITY                           ?
???????????????????????????????????????????????????????????????????
                         ?
                         ?
            ??????????????????????????
            ?  Anonymous Auth Token  ?
            ?  Sent with Every       ?
            ?  Request               ?
            ??????????????????????????
                     ?
                     ?
            ??????????????????????????
            ?  Firestore Rules       ?
            ?  Check:                ?
            ?  request.auth.uid      ?
            ?  == userId             ?
            ??????????????????????????
                     ?
        ???????????????????????????
        ?                         ?
        ?                         ?
????????????????          ????????????????
?  Match?      ?   NO     ?  403 Denied  ?
?              ????????????  Can't Read  ?
????????????????          ?  Other Users ?
       ? YES               ????????????????
       ?                         
       ?                         
????????????????          
? Allow Access ?          
? to Own Data  ?          
????????????????          
```

## Data Sync Scenarios

### Scenario 1: New User
```
1. Open game ? Create anonymous user ? UID: abc123
2. Create character ? Save to /users/abc123/characters/char1
3. Close tab
4. Reopen game ? Same browser ? Same UID ? Load saved character ?
```

### Scenario 2: Cross-Device (Same Browser)
```
1. Play on Chrome Desktop ? UID: abc123 ? Save character
2. Open Chrome Mobile ? Different UID: xyz789 ? New character ?

Note: Anonymous auth is per-browser, not per-account
To sync across devices, need to convert to email/password account
```

### Scenario 3: Offline Play
```
1. Play online ? Create character ? Saved to cloud ?
2. Go offline ? Level up ? Saved to IndexedDB ??
3. Go online ? Auto-sync ? Pushed to Firestore ?
```

### Scenario 4: Multiple Tabs
```
1. Open Tab A ? UID: abc123 ? Character "Warrior"
2. Open Tab B ? Same UID: abc123 ? Loads "Warrior" ?
3. Tab A: Level up ? Save ? Tab B: Sees update ?

Note: Real-time sync works within same browser!
```

## Performance & Costs

### Free Tier Limits
- **Reads**: 50,000/day
- **Writes**: 20,000/day
- **Storage**: 1 GB
- **Network**: 10 GB/month

### Estimated Usage (per user per day)
- **Reads**: 10-20 (load character, settings)
- **Writes**: 50-100 (auto-saves, battle logs)

### Scalability
- 1,000 daily users = ~50K reads + ~75K writes
- Free tier can handle ~500-700 daily active users
- Beyond that, upgrade to Blaze plan (~$0.06 per 100K reads)

## Security Best Practices

? **DO**
- Use environment variables for Firebase config
- Keep security rules strict (user can only access own data)
- Enable offline persistence for better UX
- Validate data on client AND server (security rules)

? **DON'T**
- Commit `.env` to Git
- Share Firebase config publicly (it's okay in client code, but protect project)
- Allow users to read other users' data
- Store sensitive info in Firestore (it's for game data only)

## Monitoring

Check Firebase Console regularly:

1. **Authentication** ? See total anonymous users
2. **Firestore** ? Monitor read/write usage
3. **Usage & Billing** ? Track quota consumption
4. **Logs** ? Check for errors or suspicious activity

Set up alerts:
- Budget alerts (if using Blaze plan)
- Usage alerts (approaching quotas)
- Security alerts (suspicious activity)
